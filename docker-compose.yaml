version: "3.8"

services:
  # -----------------
  # BROKER
  # -----------------
  broker:
    build:
      context: .
      dockerfile: broker/Dockerfile
    ports:
      - "50050:50050"
    environment:
      - BROKER_PORT=50050
      - DATANODE_ADDRESSES=10.35.168.17:50051,10.35.168.112:50051,10.35.168.15:50051
      - CONSENSUS_ADDRESSES=10.35.168.16:50060,10.35.168.17:50060,10.35.168.112:50060
    profiles:
      - vm1

  mr_client1:
    container_name: mr_client1
    build:
      context: .
      dockerfile: mr_client/Dockerfile
    environment:
      - BROKER_ADDR=10.35.168.15:50050
    profiles:
      - vm1

  mr_client2:
    container_name: mr_client2
    build:
      context: .
      dockerfile: mr_client/Dockerfile
    environment:
      - BROKER_ADDR=10.35.168.15:50050
    profiles:
      - vm2

  datanode1:
    build:
      context: .
      dockerfile: datanode/Dockerfile
    environment:
      - DATANODE_ID=D1
      - DATANODE_ADDR=10.35.168.17:50051
      - DATANODE_ADDRESSES=10.35.168.17:50051,10.35.168.112:50051,10.35.168.15:50051
      - DATANODE_PORT=50051
    ports:
      - "50051:50051"
    profiles:
      - vm3

  datanode2:
    build:
      context: .
      dockerfile: datanode/Dockerfile
    environment:
      - DATANODE_ID=D2
      - DATANODE_ADDR=10.35.168.112:50051
      - DATANODE_ADDRESSES=10.35.168.17:50051,10.35.168.112:50051,10.35.168.15:50051
      - DATANODE_PORT=50051
    ports:
      - "50051:50051"
    profiles:
      - vm4

  datanode3:
    build:
      context: .
      dockerfile: datanode/Dockerfile
    environment:
      - DATANODE_ID=D3
      - DATANODE_ADDR=10.35.168.15:50051
      - DATANODE_ADDRESSES=10.35.168.17:50051,10.35.168.112:50051,10.35.168.15:50051
      - DATANODE_PORT=50051
    ports:
      - "50051:50051"
    profiles:
      - vm1

  # ----------------------------------------
  # CLÃšSTER DE CONSENSO (ATC)
  # ----------------------------------------

  consensus1:
    container_name: consensus1
    build:
      context: .
      dockerfile: consensus/Dockerfile
    ports:
      - "50060:50060"
    environment:
      - NODE_ID=ATC-1
      - CONSENSUS_PORT=:50060
      - PEER_ADDRESSES=ATC-2=10.35.168.17:50060,ATC-3=10.35.168.112:50060
    profiles:
      - vm2

  consensus2:
    container_name: consensus2
    build:
      context: .
      dockerfile: consensus/Dockerfile
    ports:
      - "50060:50060"
    environment:
      - NODE_ID=ATC-2
      - CONSENSUS_PORT=:50060
      - PEER_ADDRESSES=ATC-1=10.35.168.16:50060,ATC-3=10.35.168.112:50060
    profiles:
      - vm3

  consensus3:
    container_name: consensus3
    build:
      context: .
      dockerfile: consensus/Dockerfile
    ports:
      - "50060:50060"
    environment:
      - NODE_ID=ATC-3
      - CONSENSUS_PORT=:50060
      - PEER_ADDRESSES=ATC-1=10.35.168.16:50060,ATC-2=10.35.168.17:50060
    profiles:
      - vm4

  # COORDINADOR
  coordinator:
    build:
      context: .
      dockerfile: coordinator/Dockerfile
    ports:
      - "50070:50070"
    environment:
      - COORDINATOR_PORT=:50070
      - BROKER_ADDR=10.35.168.15:50050
    profiles:
      - vm4

  # CLIENTES RYW (Pasajeros)
  ryw_client1:
    build:
      context: .
      dockerfile: ryw_client/Dockerfile
    environment:
      - CLIENT_ID=Pasajero-1
      - COORDINATOR_ADDR=10.35.168.112:50070
    profiles:
      - vm1

  ryw_client2:
    build:
      context: .
      dockerfile: ryw_client/Dockerfile
    environment:
      - CLIENT_ID=Pasajero-2
      - COORDINATOR_ADDR=10.35.168.112:50070
    profiles:
      - vm2

  ryw_client3:
    build:
      context: .
      dockerfile: ryw_client/Dockerfile
    environment:
      - CLIENT_ID=Pasajero-3
      - COORDINATOR_ADDR=10.35.168.112:50070
    profiles:
      - vm3
